<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kisan Vaahan - Marketplace</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    header { display:flex; justify-content:space-between; align-items:center; }
    .product { border:1px solid #ddd; padding:12px; margin:8px; border-radius:8px; display:flex; gap:12px; }
    .product img { width:120px; height:80px; object-fit:cover; border-radius:6px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:12px; }
    .btn { padding:8px 10px; border:none; background:#2b7; color:#fff; border-radius:6px; cursor:pointer; }
    .btn.secondary { background:#29a; }
    .small { font-size:0.9rem; color:#555; }
    #messages { margin-top:12px; color:crimson; }
  </style>
</head>
<body>
<header>
  <h1>Kisan Vaahan</h1>
  <div>
    <button class="btn" id="btn-login">Login</button>
    <button class="btn secondary" id="btn-register">Register</button>
    <button class="btn" id="btn-cart">Cart (<span id="cart-count">0</span>)</button>
    <button class="btn" id="btn-logout" style="display:none">Logout</button>
  </div>
</header>

<section>
  <h2>Products</h2>
  <div id="products" class="grid"></div>
</section>

<div id="messages"></div>

<!-- Hidden dialogs (simple) -->
<div id="auth-dialog" style="display:none; position:fixed; right:20px; top:60px; padding:12px; background:#fff; border:1px solid #ccc; border-radius:8px;">
  <h3 id="auth-title">Login</h3>
  <div>
    <input id="auth-name" placeholder="Name (register only)" style="display:none" />
    <br/><input id="auth-email" placeholder="Email" />
    <br/><input id="auth-password" type="password" placeholder="Password" />
    <br/><button class="btn" id="auth-submit">Submit</button>
    <button class="btn secondary" id="auth-cancel">Cancel</button>
  </div>
</div>

<!-- Cart dialog -->
<div id="cart-dialog" style="display:none; position:fixed; left:20px; top:60px; width:360px; max-height:80vh; overflow:auto; padding:12px; background:#fff; border:1px solid #ccc; border-radius:8px;">
  <h3>Your Cart</h3>
  <div id="cart-items"></div>
  <div style="margin-top:8px;">
    <button class="btn" id="checkout">Place Order</button>
    <button class="btn secondary" id="cart-close">Close</button>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8000'; // <-- change if backend host/port differs

// Utilities
function $id(id){ return document.getElementById(id); }
function showMessage(msg, clr='crimson'){ const el=$id('messages'); el.style.color=clr; el.textContent=msg; setTimeout(()=>{ if(el.textContent===msg) el.textContent=''; }, 6000); }
function isLogged(){ return !!localStorage.getItem('kv_token'); }
function authHeader(){ const t = localStorage.getItem('kv_token'); return t ? { 'Authorization': 'Bearer '+t } : {}; }

// Cart stored in localStorage (simple)
function getCart(){ return JSON.parse(localStorage.getItem('kv_cart')||'[]'); }
function saveCart(cart){ localStorage.setItem('kv_cart', JSON.stringify(cart)); $id('cart-count').textContent = cart.reduce((s,i)=>s+i.qty,0); }

// Init cart count
saveCart(getCart());

// DOM refs
const productsEl = $id('products');
const authDialog = $id('auth-dialog');
const authTitle = $id('auth-title');
const authName = $id('auth-name');
const authEmail = $id('auth-email');
const authPassword = $id('auth-password');
const authSubmit = $id('auth-submit');
const authCancel = $id('auth-cancel');

const cartDialog = $id('cart-dialog');
const cartItems = $id('cart-items');

$id('btn-login').addEventListener('click', ()=>openAuth('login'));
$id('btn-register').addEventListener('click', ()=>openAuth('register'));
$id('btn-cart').addEventListener('click', ()=>openCart());
$id('cart-close').addEventListener('click', ()=>cartDialog.style.display='none');
$id('auth-cancel').addEventListener('click', ()=>authDialog.style.display='none');
$id('btn-logout').addEventListener('click', ()=>{ localStorage.removeItem('kv_token'); showMessage('Logged out','green'); toggleAuthButtons(); });

function toggleAuthButtons(){
  if(isLogged()){
    $id('btn-login').style.display='none';
    $id('btn-register').style.display='none';
    $id('btn-logout').style.display='inline-block';
  } else {
    $id('btn-login').style.display='inline-block';
    $id('btn-register').style.display='inline-block';
    $id('btn-logout').style.display='none';
  }
}

// Auth dialog
let currentAuthMode = 'login';
function openAuth(mode){
  currentAuthMode = mode;
  authTitle.textContent = mode === 'login' ? 'Login' : 'Register';
  authName.style.display = mode === 'register' ? 'block' : 'none';
  authEmail.value=''; authPassword.value=''; authName.value='';
  authDialog.style.display='block';
}
authSubmit.addEventListener('click', async ()=> {
  const email = authEmail.value.trim();
  const password = authPassword.value;
  const name = authName.value.trim();
  if(!email || !password) { showMessage('Email and password required'); return; }

  try {
    if(currentAuthMode === 'register'){
      // Registration endpoint - adjust payload keys to your backend (here: name,email,password)
      const res = await fetch(API_BASE + '/auth/register', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, email, password })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || JSON.stringify(data));
      showMessage('Registration successful — please login', 'green');
      openAuth('login');
    } else {
      // Login endpoint - expects email & password, returns access token
      const res = await fetch(API_BASE + '/auth/login', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || JSON.stringify(data));
      // If your backend returns {"access_token": "..."} or similar, adapt here:
      const token = data.access_token || data.token || data.access;
      if(!token) throw new Error('No token returned by server');
      localStorage.setItem('kv_token', token);
      showMessage('Logged in', 'green');
      authDialog.style.display='none';
      toggleAuthButtons();
    }
  } catch(err){
    showMessage('Auth error: '+err.message);
  }
});

// Fetch products from backend
async function loadProducts(){
  try {
    const res = await fetch(API_BASE + '/products'); // adjust endpoint to your backend route
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail || JSON.stringify(data));
    renderProducts(data);
  } catch(err){
    showMessage('Cannot load products: '+err.message);
  }
}

function renderProducts(items){
  productsEl.innerHTML='';
  items.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'product';
    const img = document.createElement('img');
    img.src = p.image || 'https://via.placeholder.com/240x160?text=No+Image';
    const info = document.createElement('div');
    info.innerHTML = `<h3>${p.title || p.name}</h3><div class="small">${p.description || ''}</div><strong>₹ ${p.price ?? p.rate ?? 0}</strong>`;
    const actions = document.createElement('div');
    const qty = document.createElement('input'); qty.type='number'; qty.min=1; qty.value=1; qty.style.width='60px';
    const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Add to cart';
    addBtn.onclick = ()=> addToCart(p, parseInt(qty.value||1,10));
    actions.appendChild(qty); actions.appendChild(addBtn);
    div.appendChild(img); div.appendChild(info); div.appendChild(actions);
    productsEl.appendChild(div);
  });
}

// Cart functions
function addToCart(product, quantity=1){
  const cart = getCart();
  const existing = cart.find(i=>i.id === product.id || i.id === product._id || i.id === product.product_id);
  const id = product.id || product._id || product.product_id;
  const price = product.price ?? product.rate ?? 0;
  if(existing){
    existing.qty += quantity;
  } else {
    cart.push({ id, title: product.title || product.name, qty: quantity, price });
  }
  saveCart(cart);
  showMessage('Added to cart','green');
}

// Open cart
function openCart(){
  const cart = getCart();
  cartItems.innerHTML = '';
  if(cart.length===0){ cartItems.innerHTML = '<div class="small">Cart is empty</div>'; cartDialog.style.display='block'; return; }
  cart.forEach((it, idx)=>{
    const el = document.createElement('div');
    el.style.borderBottom='1px dashed #eee';
    el.style.padding='6px 0';
    el.innerHTML = `<strong>${it.title}</strong> <div class="small">Qty: <input value="${it.qty}" style="width:60px" data-idx="${idx}" class="cart-qty" /></div> <div>₹ ${it.price * it.qty}</div> <button class="btn" data-remove="${idx}">Remove</button>`;
    cartItems.appendChild(el);
  });
  // attach listeners
  cartItems.querySelectorAll('.cart-qty').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const idx = +e.target.dataset.idx; const val = parseInt(e.target.value||1,10);
      const c = getCart(); c[idx].qty = Math.max(1,val); saveCart(c); openCart();
    });
  });
  cartItems.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const idx = +e.target.dataset.remove;
      const c = getCart(); c.splice(idx,1); saveCart(c); openCart();
    });
  });

  cartDialog.style.display='block';
}

// Checkout / order placement
$id('checkout').addEventListener('click', async ()=>{
  if(!isLogged()){ showMessage('Login required to place order'); return; }
  const cart = getCart();
  if(cart.length===0){ showMessage('Cart empty'); return; }
  // Build order payload - adapt to your backend expected schema
  const orderPayload = {
    items: cart.map(i=>({ product_id: i.id, quantity: i.qty, price: i.price })),
    total: cart.reduce((s,i)=>s + i.qty * i.price, 0),
    address: 'Pickup location (update front-end to collect real address)'
  };
  try {
    const res = await fetch(API_BASE + '/orders', {
      method: 'POST',
      headers: Object.assign({ 'Content-Type':'application/json' }, authHeader()),
      body: JSON.stringify(orderPayload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail || JSON.stringify(data));
    localStorage.removeItem('kv_cart');
    saveCart([]);
    cartDialog.style.display='none';
    showMessage('Order placed successfully', 'green');
  } catch(err){
    showMessage('Order error: '+err.message);
  }
});

// Boot
toggleAuthButtons();
loadProducts();
</script>
</body>
</html>
