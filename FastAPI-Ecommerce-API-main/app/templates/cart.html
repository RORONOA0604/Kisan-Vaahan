<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart | Kisan Vaahan</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'kisan-green': '#22C55E',
            'kisan-dark': '#047857',
            'kisan-light': '#D1FAE5',
          }
        }
      }
    }
  </script>

  <style>
    .fade-in { animation: fadeIn .15s ease both; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
  </style>
</head>

<body class="bg-gray-50 font-sans text-gray-800" style="zoom: 70%; overflow-x: hidden;">

<!-- HEADER -->
<header class="bg-white shadow-md sticky top-3 z-30">
  <div class="flex justify-between items-center px-10 py-3">
    <div class="flex items-center space-x-5 cursor-pointer" onclick="window.location.href='{{ url_for('landing_page') }}'">
      <img src="/static/logo.png" class="h-24 w-24 object-contain" />
      <h1 class="text-4xl font-extrabold text-kisan-dark">KISAN VAAHAN</h1>
    </div>
    <a href="{{ url_for('buyer_market') }}" class="px-6 py-2 bg-kisan-green text-white rounded-lg font-semibold hover:bg-kisan-dark transition">
      Continue Shopping
    </a>
  </div>
</header>

<section class="max-w-5xl mx-auto px-6 py-10">
  <h2 class="text-4xl font-bold text-kisan-dark mb-8">Your Shopping Cart</h2>

  <div id="cart-items" class="space-y-5"></div>

  <div class="mt-12 bg-white shadow p-6 rounded-lg">
    <h2 class="text-2xl font-bold text-kisan-dark mb-4">Billing Summary</h2>

    <div class="flex justify-between text-lg py-2"><span>Subtotal</span><span id="subtotal">â‚¹0</span></div>
    <div class="flex justify-between text-lg py-2"><span>GST (5%)</span><span id="gst">â‚¹0</span></div>
    <div class="flex justify-between text-lg py-2"><span>Delivery Charges</span><span id="delivery">â‚¹0</span></div>

    <hr class="my-3">

    <div class="flex justify-between text-2xl font-bold py-2"><span>Total</span><span id="total">â‚¹0</span></div>
  </div>

  <div class="mt-10 bg-white shadow p-6 rounded-lg">
    <h2 class="text-2xl font-bold text-kisan-dark mb-4">Delivery Address</h2>
    <textarea id="delivery-address" rows="3" 
      class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-kisan-green outline-none"
      placeholder="Enter your delivery address..."></textarea>

    <h2 class="text-2xl font-bold text-kisan-dark mb-4 mt-6">Choose Payment Method</h2>

    <select id="payment-method" class="w-full border px-4 py-3 rounded-lg text-lg">
      <option value="COD">Cash on Delivery</option>
      <option value="UPI">UPI Payment</option>
    </select>

    <p id="min-warning" class="text-red-600 font-semibold text-center mt-4 hidden">
      Minimum order amount is â‚¹500 to proceed ðŸšœ
    </p>

    <button id="checkout-btn" onclick="placeOrder()" disabled
      class="mt-6 w-full bg-kisan-green text-white text-xl py-3 rounded-lg hover:bg-kisan-dark transition opacity-50 cursor-not-allowed">
      Proceed to Place Order âœ…
    </button>

  </div>

</section>

<!-- UPI PAYMENT POPUP -->
<div id="upiPopup" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-96">
    <h2 class="text-2xl font-bold text-kisan-dark mb-4">Scan & Pay</h2>

    <img src="/static/upiqr.png" class="w-60 mx-auto rounded-lg shadow" />

    <p class="text-gray-600 mt-3">Please complete the payment and click below</p>

    <button onclick="confirmUPIPayment()"
      class="mt-6 w-full bg-kisan-green text-white py-3 rounded-lg font-bold hover:bg-kisan-dark transition">
      I Have Paid âœ”
    </button>

    <button onclick="closeUPI()"
      class="mt-3 w-full py-2 rounded-lg border border-gray-400">
      Cancel
    </button>
  </div>
</div>

<script>
  const API_BASE = "";  // Same origin
  let cartData = null;

  // Utility: show toast
  function showToast(msg, timeout = 2000) {
    const t = document.createElement('div');
    t.innerText = msg;
    t.style = "position:fixed;right:20px;top:20px;background:#16a34a;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:9999;font-weight:600";
    document.body.appendChild(t);
    setTimeout(() => t.remove(), timeout);
  }

  // Get token
  function getToken() {
    return localStorage.getItem("access_token");
  }

  // Fetch cart from backend
  async function loadCart() {
    const token = getToken();
    if (!token) {
      document.getElementById("cart-items").innerHTML = `<p class="text-center text-gray-600 text-xl py-10">Please <a href="{{ url_for('buyer_login') }}" class="text-kisan-green underline">login</a> to view your cart</p>`;
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/carts/me`, {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) {
        throw new Error("Failed to load cart");
      }

      const json = await res.json();
      cartData = json.data;
      renderCart();
    } catch (err) {
      console.error("loadCart error", err);
      document.getElementById("cart-items").innerHTML = `<p class="text-center text-red-600 text-xl py-10">Error loading cart. Please try again.</p>`;
    }
  }

  function renderCart() {
    const container = document.getElementById("cart-items");
    container.innerHTML = "";

    if (!cartData || !cartData.cart_items || cartData.cart_items.length === 0) {
      container.innerHTML = `<p class="text-center text-gray-600 text-xl py-10">Your cart is empty ðŸ›’</p>`;
      updateTotals();
      return;
    }

    cartData.cart_items.forEach(item => {
      const product = item.product;
      const card = document.createElement("div");
      card.className = "flex items-center justify-between bg-white p-5 rounded-lg shadow border border-gray-200";
      card.innerHTML = `
        <div>
          <h3 class="font-bold text-xl text-kisan-dark">${product.title}</h3>
          <p class="text-gray-600">â‚¹${product.price} per unit</p>
        </div>

        <div class="flex items-center">
          <button onclick="updateQty(${item.id}, ${item.quantity - 1})" class="px-3 py-1 text-lg border border-kisan-green rounded-l-lg">-</button>
          <span class="px-4 py-1 bg-kisan-light font-semibold">${item.quantity}</span>
          <button onclick="updateQty(${item.id}, ${item.quantity + 1})" class="px-3 py-1 text-lg border border-kisan-green rounded-r-lg">+</button>
        </div>

        <span class="font-bold text-kisan-dark text-xl">â‚¹${item.subtotal.toFixed(2)}</span>

        <button onclick="removeItem(${item.id})" class="text-red-600 font-bold text-xl hover:text-red-800">âœ•</button>
      `;
      container.appendChild(card);
    });

    updateTotals();
  }

  async function updateQty(itemId, newQty) {
    if (newQty < 1) return;

    const token = getToken();
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE}/carts/items/${itemId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ quantity: newQty })
      });

      if (!res.ok) throw new Error("Failed to update");

      const json = await res.json();
      cartData = json.data;
      renderCart();
      showToast("Quantity updated");
    } catch (err) {
      console.error("updateQty error", err);
      showToast("Failed to update quantity");
    }
  }

  async function removeItem(itemId) {
    const token = getToken();
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE}/carts/items/${itemId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) throw new Error("Failed to remove");

      const json = await res.json();
      cartData = json.data;
      renderCart();
      showToast("Item removed");
    } catch (err) {
      console.error("removeItem error", err);
      showToast("Failed to remove item");
    }
  }

  function updateTotals() {
    const subtotal = cartData ? cartData.total_amount : 0;
    const gst = subtotal * 0.05;
    const delivery = (subtotal > 0 ? 50 : 0);
    const total = subtotal + gst + delivery;

    document.getElementById("subtotal").innerText = "â‚¹" + subtotal.toFixed(2);
    document.getElementById("gst").innerText = "â‚¹" + gst.toFixed(2);
    document.getElementById("delivery").innerText = "â‚¹" + delivery.toFixed(2);
    document.getElementById("total").innerText = "â‚¹" + total.toFixed(2);

    const checkoutBtn = document.getElementById("checkout-btn");
    const warning = document.getElementById("min-warning");

    if (subtotal < 500 && subtotal > 0) {
      checkoutBtn.disabled = true;
      checkoutBtn.classList.add("opacity-50", "cursor-not-allowed");
      warning.classList.remove("hidden");
    } else if (subtotal >= 500) {
      checkoutBtn.disabled = false;
      checkoutBtn.classList.remove("opacity-50", "cursor-not-allowed");
      warning.classList.add("hidden");
    } else {
      checkoutBtn.disabled = true;
      checkoutBtn.classList.add("opacity-50", "cursor-not-allowed");
      warning.classList.add("hidden");
    }
  }

  async function placeOrder() {
    const address = document.getElementById("delivery-address").value.trim();
    const paymentMethod = document.getElementById("payment-method").value;

    if (!address) {
      showToast("Please enter delivery address");
      return;
    }

    if (paymentMethod === "UPI") {
      // Show UPI popup
      document.getElementById("upiPopup").classList.remove("hidden");
    } else {
      // COD - place order directly
      await createOrder(address, paymentMethod);
    }
  }

  function closeUPI() {
    document.getElementById("upiPopup").classList.add("hidden");
  }

  async function confirmUPIPayment() {
    const address = document.getElementById("delivery-address").value.trim();
    closeUPI();
    await createOrder(address, "UPI");
  }

  async function createOrder(address, paymentMethod) {
    const token = getToken();
    if (!token) {
      showToast("Please login first");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/orders/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          delivery_address: address,
          payment_method: paymentMethod
        })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({ detail: "Failed" }));
        throw new Error(err.detail || "Failed to create order");
      }

      const json = await res.json();
      showToast("Order placed successfully!");
      
      // Redirect to success page after a short delay
      setTimeout(() => {
        window.location.href = "{{ url_for('order_success') }}";
      }, 1000);
    } catch (err) {
      console.error("createOrder error", err);
      showToast(err.message || "Failed to place order");
    }
  }

  window.onload = loadCart;
</script>

</body>
</html>
