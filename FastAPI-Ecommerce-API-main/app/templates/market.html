<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kisan Vaahan | Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'kisan-green': '#22C55E',
            'kisan-dark': '#047857',
            'kisan-light': '#D1FAE5',
          },
          boxShadow: { 'card-lift': '0 4px 10px rgba(0,0,0,0.08)' }
        }
      }
    }
  </script>

  <style>
    .fade-in {
      animation: fadeIn .15s ease both;
    }

    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    /* Added style for toast notification */
    .toast-notification {
      animation: slideInUp 0.3s ease forwards;
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body class="bg-gray-50 font-sans text-gray-800" style="zoom: 70%; overflow-x: hidden;">

  <header class="bg-white shadow-md sticky top-3 z-30">
    <div class="flex justify-between items-center px-6 md:px-10 py-3 max-w-8xl mx-auto">
      <div class="flex items-center space-x-4 cursor-pointer">
        <img src="logo.jpg" alt="Kisan Vaahan Logo"
          class="h-20 w-20 object-contain transform hover:rotate-12 transition-transform duration-400" />
        <h1
          class="text-3xl md:text-4xl font-extrabold text-kisan-dark tracking-tight leading-none transform hover:scale-105 transition-transform duration-300">
          KISAN VAAHAN
        </h1>
      </div>

      <nav class="hidden lg:flex items-center space-x-6">
        <a href="{{ url_for('landing_page') }}"
          class="text-kisan-dark hover:text-kisan-green text-lg font-semibold">Home</a>
        <a href="{{ url_for('about') }}" class="text-kisan-dark hover:text-kisan-green text-lg font-semibold">About</a>
        <a href="{{ url_for('contact') }}"
          class="text-kisan-dark hover:text-kisan-green text-lg font-semibold">Contact</a>

        <a href="{{ url_for('buyer_cart') }}"
          class="ml-4 px-4 py-2 border border-kisan-green rounded-lg text-base font-semibold hover:bg-kisan-dark hover:text-white transition text-center flex items-center gap-2">
          ðŸ›’ View Cart
          <span id="cart-badge" class="inline-block px-2 py-1 text-sm bg-kisan-green text-white rounded-full">0</span>
        </a>
      </nav>
    </div>
  </header>

  <div class="flex flex-1 min-h-[calc(100vh-8rem)] max-w-8xl mx-auto px-4 md:px-6 py-8 gap-8">

    <aside
      class="w-64 bg-white shadow-lg border border-gray-200 p-6 hidden md:flex flex-col justify-between rounded-xl">
      <div>
        <div class="flex items-center space-x-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-2xl">ðŸ‘¤
          </div>
          <div>
            <p class="font-semibold text-lg text-gray-800">Kisan Vaahan</p>
            <p class="text-sm text-gray-500">Buyer Portal</p>
          </div>
        </div>
        <nav>
          <ul class="space-y-2">
            <li>
              <a href="{{ url_for('buyer_market') }}"
                class="flex items-center p-3 rounded-lg text-kisan-dark bg-kisan-light font-medium hover:bg-kisan-green hover:text-white transition">
                <span class="mr-3 text-xl">ðŸ›’</span> Marketplace
              </a>
            </li>
            <li>
              <a href="{{ url_for('buyer_orders') }}"
                class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-kisan-dark transition">
                <span class="mr-3 text-xl">ðŸ“¦</span> My Orders
              </a>
            </li>
            <li>
              <a href="{{ url_for('buyer_profile') }}"
                class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-kisan-dark transition">
                <span class="mr-3 text-xl">ðŸ‘¤</span> Profile
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <div class="mt-6">
        <button onclick="confirmLogout()"
          class="w-full bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition">
          Log Out
        </button>
      </div>
    </aside>

    <main class="flex-1">
      <section class="mb-6">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6 mb-6">
          <div>
            <h2 class="text-4xl md:text-6xl font-extrabold text-kisan-dark">Marketplace</h2>
            <p class="text-lg md:text-2xl text-gray-600 mt-1">Browse products from farmers across India</p>
          </div>

          <div class="w-full md:w-auto flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
            <input id="searchBar" type="text" placeholder="Search products..."
              class="border border-gray-300 rounded-lg px-4 py-2 w-full sm:w-64 focus:ring-2 focus:ring-kisan-green outline-none">
            <select id="categoryFilter"
              class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-kisan-green outline-none">
              <option value="all">All Categories</option>
              <option value="Vegetables">Vegetables</option>
              <option value="Fruits">Fruits</option>
              <option value="Grains">Grains</option>
              <option value="Pulses">Pulses</option>
              <option value="Millets">Millets</option>
            </select>
            <select id="sortFilter"
              class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-kisan-green outline-none">
              <option value="default">Sort by</option>
              <option value="low">Price: Low to High</option>
              <option value="high">Price: High to Low</option>
            </select>
            <a href="{{ url_for('buyer_cart') }}"
              class="px-4 py-2 border border-kisan-green rounded-lg text-base font-semibold hover:bg-kisan-dark hover:text-white transition text-center">
              Quick Cart
            </a>
          </div>
        </div>
      </section>

      <section>
        <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        </div>
      </section>
    </main>
  </div>

  <footer class="bg-kisan-dark text-white py-8 text-center mt-8">
    <p class="text-lg">Â© 2025 Kisan Vaahan. All Rights Reserved.</p>
  </footer>

  <div id="logoutModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-lg fade-in text-center">
      <h3 class="text-xl font-bold text-kisan-dark mb-3">Confirm Logout</h3>
      <p class="text-gray-700 mb-6">Are you sure you want to log out?</p>
      <div class="flex justify-center gap-4">
        <button onclick="closeLogout()"
          class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100">No</button>
        <button onclick="proceedLogout()"
          class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Yes, Log Out</button>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById("productGrid");
    const searchBar = document.getElementById("searchBar");
    const categoryFilter = document.getElementById("categoryFilter");
    const sortFilter = document.getElementById("sortFilter");
    const logoutModal = document.getElementById("logoutModal");

    function confirmLogout() { logoutModal.classList.remove("hidden"); }
    function closeLogout() { logoutModal.classList.add("hidden"); }
    function proceedLogout() {
      logoutModal.classList.add("hidden");
      // clear token and redirect to landing page
      localStorage.removeItem("access_token");
      window.location.href = '{{ url_for("landing_page") }}';
    }

    // ====== Products - Hardcoded Data (No Fetch) ======
    const defaultProducts = [
      { id: 1, name: "Organic Tomatoes", category: "Vegetables", price: 40, image: "https://img.freepik.com/free-photo/top-view-ripe-fresh-tomatoes-with-water-drops-black-background_141793-3432.jpg", desc: "Naturally grown, juicy and full of flavor." },
      { id: 2, name: "Green Gram", category: "Pulses", price: 140, image: "https://www.agrifarming.in/wp-content/uploads/Ultimate-Guide-to-Green-Gram-Farming-1.jpg", desc: "Rich in protein and very nutritious." },
      { id: 3, name: "Maize", category: "Grains", price: 50, image: "https://thumbs.dreamstime.com/b/corn-maize-seeds-close-up-shot-above-57602986.jpg", desc: "Fresh maize perfect for flour and meals." },
      { id: 4, name: "Organic Carrots", category: "Vegetables", price: 40, image: "https://www.tasteofhome.com/wp-content/uploads/2019/01/carrots-shutterstock_789443206.jpg", desc: "Sweet, crunchy carrots rich in Vitamin A." },
      { id: 5, name: "Ragi", category: "Millets", price: 80, image: "https://5.imimg.com/data5/SELLER/Default/2022/9/ZB/GS/FR/25008022/jiwa-organic-ragi-flour.jpg", desc: "High in calcium & fiber. Ideal for healthy meals." },
      { id: 6, name: "Guava", category: "Fruits", price: 50, image: "https://growbilliontrees.com/cdn/shop/articles/guava-tree-grow-billion-trees.jpg?v=1712390096&width=1100", desc: "Fresh, crispy & naturally sweet." },
      { id: 7, name: "Coconuts", category: "Fruits", price: 50, image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSPwaITxxnnksBGzs7bVXx54f5DFKWGsZJMflRaianxpmncBI7YJzotwTuBMMCDEaoimkY&usqp=CAU", desc: "Sweet tender coconuts full of refreshing water." },
      { id: 8, name: "Green Capsicum", category: "Vegetables", price: 50, image: "https://5.imimg.com/data5/SELLER/Default/2024/5/415703280/EK/TS/LQ/212628420/green-capsicum-500x500.webp", desc: "Crisp, fresh and perfect for curries & salads." },
      { id: 9, name: "Nimbu", category: "Fruits", price: 50, image: "https://akm-img-a-in.tosshub.com/aajtak/images/story/202303/nimbu7788778-sixteen_nine.jpg?size=948:533", desc: "Fresh lemons perfect for juice, flavor & pickles." }
    ];

    // Render product cards
    function loadProducts() {
      grid.innerHTML = "";

      if (defaultProducts.length === 0) {
        grid.innerHTML = `<p class="col-span-full text-center text-gray-600 text-xl py-10">No products available</p>`;
        return;
      }

      defaultProducts.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card border bg-white rounded-xl p-4 md:p-5 shadow-card-lift transition relative";
        card.dataset.productId = p.id;
        card.dataset.name = p.name;
        card.dataset.category = p.category;
        card.dataset.price = p.price;

        card.innerHTML = `
          <span class="success-msg hidden absolute inset-0 bg-kisan-green/90 text-white flex flex-col items-center justify-center rounded-xl text-xl font-bold z-20 transition duration-500" style="opacity:0;">âœ… Added to Cart</span>
          <div class="relative h-52 md:h-64 rounded-lg overflow-hidden group">
            <img src="${p.image}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/50 text-white opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-center px-2 text-sm md:text-lg">${p.desc}</div>
          </div>
          <h3 class="mt-4 font-bold text-lg">${p.name}</h3>
          <p class="text-gray-600 text-sm">Farmer â€¢ India</p>
          <div class="flex justify-between mt-3 items-center">
            <span class="font-bold text-kisan-dark text-lg">â‚¹${p.price}/Kg</span>
            <span class="bg-kisan-light px-3 py-1 text-xs font-bold rounded-full">In Stock</span>
          </div>
          <div class="flex justify-between items-center mt-4">
            <div class="flex items-center border border-kisan-green rounded-lg px-3">
              <button onclick="changeQty(this, -1)" class="px-2">-</button>
              <span class="px-3 font-semibold qty">1</span>
              <button onclick="changeQty(this, 1)" class="px-2">+</button>
            </div>
            <button onclick="addToCart(this)" data-name="${p.name}" data-price="${p.price}" class="bg-kisan-green text-white px-4 py-2 rounded-lg hover:bg-kisan-dark">Add to Cart</button>
          </div>`;
        grid.appendChild(card);
      });
      updateUI();
    }

    function getCards() { return Array.from(grid.querySelectorAll(".product-card")); }

    function applyFilters() {
      const q = (searchBar?.value || "").trim().toLowerCase();
      const cat = (categoryFilter?.value || "all");
      getCards().forEach(card => {
        const name = (card.dataset.name || "").toLowerCase();
        // Default to 'all' if category data is missing on the card
        const cardCat = (card.dataset.category || "all");
        const matchSearch = q === "" || name.includes(q);
        // Loose comparison to handle potential case differences in backend data
        const matchCategory = (cat === "all") || (cardCat.toLowerCase() === cat.toLowerCase());
        card.style.display = (matchSearch && matchCategory) ? "block" : "none";
      });
    }

    function applySort() {
      const mode = sortFilter?.value || "default";
      if (mode === "default") return;
      const cards = getCards();
      cards.sort((a, b) => {
        const pa = parseFloat(a.dataset.price || "0");
        const pb = parseFloat(b.dataset.price || "0");
        return mode === "low" ? pa - pb : pb - pa;
      });
      // Re-appending sorts them visually in the DOM
      cards.forEach(c => grid.appendChild(c));
    }

    function updateUI() { applyFilters(); applySort(); }

    searchBar?.addEventListener("input", updateUI);
    categoryFilter?.addEventListener("change", updateUI);
    sortFilter?.addEventListener("change", updateUI);

    // ====== Cart Backend Integration ======

    // Call backend POST /carts/add-item
    async function addToCartAPI(productId, qty = 1) {
      const token = localStorage.getItem("access_token");
      if (!token) {
        // not logged in
        showToast("Please login to add items");
        // Adjust login URL if needed
        setTimeout(() => window.location.href = "{{ url_for('buyer_login') }}", 1500);
        return { ok: false, msg: "not_logged_in" };
      }

      try {
        const res = await fetch("/carts/add-item", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ product_id: productId, quantity: qty })
        });

        if (!res.ok) {
          // Try to parse error message from backend
          const err = await res.json().catch(() => ({ detail: res.statusText }));
          console.warn("addToCartAPI failed", err);
          // Handle specific backend error formats if known (e.g. err.message or err.detail)
          return { ok: false, msg: err.detail || err.message || "Failed to add item" };
        }

        const body = await res.json();
        return { ok: true, body };
      } catch (e) {
        console.error("addToCartAPI error", e);
        return { ok: false, msg: "Network error. Please try again." };
      }
    }

    // Utility: show a small toast notification (Fixed)
    function showToast(msg, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-5 right-5 bg-kisan-dark text-white px-6 py-3 rounded-lg shadow-lg z-50 toast-notification';
      toast.innerText = msg;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.5s ease-out';
        setTimeout(() => document.body.removeChild(toast), 500);
      }, duration);
    }

    // Function to change quantity (Missing in original code)
    function changeQty(btn, change) {
      const parentDiv = btn.closest('div');
      const qtySpan = parentDiv.querySelector('.qty');
      let currentQty = parseInt(qtySpan.innerText) || 1;
      let newQty = currentQty + change;
      if (newQty < 1) newQty = 1;
      // Optional: Add stock limit check here if stock data is available
      qtySpan.innerText = newQty;
    }

    // Main Add to Cart handler
    async function addToCart(btn) {
      const card = btn.closest('.product-card');
      // Get ID from the card container data attribute we added in loadProducts
      const productId = parseInt(card.dataset.productId, 10);

      if (!productId || isNaN(productId)) {
        console.error("Product ID missing on card", card);
        showToast("Error: Cannot identify product.");
        return;
      }

      const qtySpan = card.querySelector('.qty');
      const qty = parseInt(qtySpan.innerText) || 1;

      // disable button briefly to prevent double clicks
      btn.disabled = true;
      const originalText = btn.innerText;
      btn.innerText = "Adding...";
      btn.style.opacity = 0.7;

      const r = await addToCartAPI(productId, qty);

      if (!r.ok) {
        showToast(r.msg || "Failed to add to cart");
      } else {
        // Success UI logic remains the same
        qtySpan.innerText = 1; // Reset quantity back to 1
        const msg = card.querySelector('.success-msg');
        if (msg) {
          msg.classList.remove('hidden');
          // Trigger reflow to ensure transition happens
          void msg.offsetWidth;
          msg.style.opacity = "1";
          setTimeout(() => {
            msg.style.opacity = "0";
            setTimeout(() => msg.classList.add('hidden'), 500);
          }, 1500);
        }
        // refresh header badge
        await refreshCartBadge();
      }

      // re-enable button
      btn.disabled = false;
      btn.innerText = originalText;
      btn.style.opacity = 1;
    }

    // GET /carts/me to update badge
    async function refreshCartBadge() {
      const badge = document.getElementById("cart-badge");
      if (!badge) return;
      const token = localStorage.getItem("access_token");
      if (!token) { badge.innerText = "0"; return; }

      try {
        const res = await fetch("/carts/me", {
          headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) {
          if (res.status === 401) {
            // Token expired or invalid
            localStorage.removeItem("access_token");
          }
          badge.innerText = "0";
          return;
        }
        const json = await res.json();
        // Adapt based on actual backend response structure for cart items
        // Assuming structure: { data: { cart_items: [...] } } OR { cart_items: [...] }
        let items = [];
        if (json.data && json.data.cart_items) {
          items = json.data.cart_items;
        } else if (json.cart_items) {
          items = json.cart_items;
        }

        const totalQty = items.reduce((s, i) => s + (parseInt(i.quantity) || 0), 0);
        badge.innerText = totalQty;
        // Animate badge update
        badge.classList.add('fade-in');
        setTimeout(() => badge.classList.remove('fade-in'), 200);

      } catch (err) {
        console.error("refreshCartBadge error", err);
        badge.innerText = "0";
      }
    }

    // Initialize page
    document.addEventListener("DOMContentLoaded", () => {
      loadProducts();
      refreshCartBadge();
    });
  </script>

</body>

</html>
