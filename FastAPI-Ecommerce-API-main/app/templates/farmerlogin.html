<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Login | Kisan Vaahan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'kisan-green': '#22C55E',
          'kisan-dark': '#047857',
          'kisan-light': '#D1FAE5',
        }
      }
    }
  }
  </script>
</head>
<body class="bg-gray-50 font-sans text-gray-800" style="zoom: 70%; overflow-x: hidden;">

<header class="bg-white shadow-md sticky top-0 z-30 py-3">
  <div class="flex justify-between items-center px-10 md:px-4 py-1 max-w-8xl mx-auto">
    <div class="flex items-center space-x-5 cursor-pointer">
      <img src="{{ url_for('static', path='logo.png') }}" alt="Kisan Vaahan Logo"
           class="h-28 w-28 object-contain transform hover:rotate-6 transition duration-300" />
      <h1 class="text-4xl font-extrabold text-kisan-dark">KISAN VAAHAN</h1>
    </div>
  </div>
</header>

<section class="flex justify-center items-center min-h-screen px-6">
  <div class="bg-white w-full max-w-md shadow-xl rounded-xl p-10 border border-gray-200">
    <h2 class="text-3xl font-extrabold text-center text-kisan-dark">Farmer Login</h2>
    <p class="text-center text-gray-600 mt-2">Login to manage your products and orders</p>

    <form id="farmerLoginForm" class="mt-10 space-y-6">
      <div>
        <label class="block text-sm font-semibold text-gray-700">Phone Number</label>
        <input name="phone" id="phone" type="tel"
          class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kisan-green"
          placeholder="+91 98765 43210" required>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700">Password</label>
        <input name="password" id="password" type="password"
          class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kisan-green"
          placeholder="Enter your password" required>
      </div>

      <p id="loginError" class="text-sm text-red-600 hidden"></p>

      <button type="submit"
        class="w-full bg-kisan-green text-white py-3 rounded-lg text-lg font-bold hover:bg-kisan-dark transition">
        Login
      </button>
    </form>

    <hr class="my-8 border-gray-300">

    <p class="text-center text-gray-700">New to Kisan Vaahan?</p>
    <a href="{{ url_for('farmer_register') }}" class="block text-center mt-3 text-kisan-green font-bold hover:text-kisan-dark">
      Create a Farmer Account â†’
    </a>
  </div>
</section>

<footer class="bg-kisan-dark text-white py-12 text-center">
  <div class="max-w-6xl mx-auto px-6">
    <p class="mt-4 text-lg">KisanVaahan Corporate Office, Bengaluru, Karnataka</p>
    <p class="mt-2 text-lg">ðŸ“ž <span class="text-kisan-green">+91 9742482379</span> | âœ‰ <span class="text-kisan-green">customercare@kisanvaahan.in</span></p>
  </div>
</footer>

<script>
document.getElementById("farmerLoginForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const errEl = document.getElementById("loginError");
  errEl.classList.add("hidden");
  errEl.textContent = "";

  const form = e.target;
  const phone = form.elements["phone"].value.trim();
  const password = form.elements["password"].value;

  if (!phone || !password) {
    errEl.textContent = "Please enter phone and password.";
    errEl.classList.remove("hidden");
    return;
  }

  // OAuth2 expects username + password â€” we use phone as username
  const fd = new FormData();
  fd.append("username", phone);
  fd.append("password", password);

  try {
    const res = await fetch("/auth/login", {
      method: "POST",
      body: fd
    });

    const text = await res.text();
    let body = null;
    try { body = JSON.parse(text); } catch(_) { body = null; }

    if (!res.ok) {
      const message = body?.detail || body?.message || text || `Login failed: ${res.status}`;
      errEl.textContent = message;
      errEl.classList.remove("hidden");
      return;
    }

    // success: body should contain access_token
    const data = body;
    localStorage.setItem("access_token", data.access_token);
    localStorage.setItem("user_type", "farmer");
    // redirect to farmer dashboard
    window.location.href = "{{ url_for('farmer_dashboard') }}";
  } catch (err) {
    console.error(err);
    errEl.textContent = "Network error. Try again.";
    errEl.classList.remove("hidden");
  }
});
</script>
</body>
</html>
